# fastfft ‚Äî —à–≤–∏–¥–∫–∏–π FFT-–º–æ–¥—É–ª—å –¥–ª—è MicroPython (RP2040)

`fastfft` ‚Äî —Ü–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π C-–º–æ–¥—É–ª—å –¥–ª—è MicroPython, –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è
—à–≤–∏–¥–∫–æ–≥–æ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è **real FFT (rFFT)** —Ç–∞ **–µ–Ω–µ—Ä–≥—ñ—ó —Å–ø–µ–∫—Ç—Ä–∞** –Ω–∞
–º—ñ–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞—Ö **RP2040** (Raspberry Pi Pico —Ç–∞ —Å—É–º—ñ—Å–Ω—ñ).

–ú–æ–¥—É–ª—å –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è:
- —Ä–æ–±–æ—Ç–∏ –±–µ–∑ heap-–∞–ª–æ–∫–∞—Ü—ñ–π –ø—ñ–¥ —á–∞—Å –≤–∏–∫–ª–∏–∫—É,
- –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ Python-overhead,
- —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ç–∞ –ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.

---

## üì¶ –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

- FFT —Ä–æ–∑–º—ñ—Ä–æ–º **512 –≤—ñ–¥–ª—ñ–∫—ñ–≤**
- –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: `int16` (`array('h')`)
- –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ: `int32` energy spectrum (`memoryview('i')`)
- FFT —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –Ω–∞ –±–∞–∑—ñ **kissFFT (float)**
- –û–±—á–∏—Å–ª–µ–Ω–Ω—è –µ–Ω–µ—Ä–≥—ñ—ó –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–≤ C-–∫–æ–¥—ñ**
- –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É **–±–µ–∑ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è** (zero-copy)
- –ü—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –∞—É–¥—ñ–æ, —Å–µ–Ω—Å–æ—Ä—ñ–≤, —Å–ø–µ–∫—Ç—Ä–æ–∞–Ω–∞–ª—ñ–∑—É

---

## ‚öôÔ∏è –í–∏–º–æ–≥–∏

- MicroPython –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é user C-modules
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: **RP2040**
- –ß–∞—Å—Ç–æ—Ç–∞ CPU: 133 –ú–ì—Ü (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å

–î–ª—è –≤—Ö—ñ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª—É:  
x[n] = A ¬∑ sin(2œÄkn / N)  
–¥–µ `N = 512`, –º–æ–¥—É–ª—å –æ–±—á–∏—Å–ª—é—î:  
Energy[k] = |FFT[k]|¬≤ / (N¬≤)  
–î–ª—è —á–∏—Å—Ç–æ—ó —Å–∏–Ω—É—Å–æ—ó–¥–∏, —á–∞—Å—Ç–æ—Ç–∞ —è–∫–æ—ó —Ç–æ—á–Ω–æ –ø–æ—Ç—Ä–∞–ø–ª—è—î –≤ FFT-–±—ñ–Ω:  
PeakEnergy ‚âà A¬≤ / 4  

---

## üìå API

### `fastfft.rfft(input)`

–û–±—á–∏—Å–ª—é—î real FFT —ñ –ø–æ–≤–µ—Ä—Ç–∞—î **–µ–Ω–µ—Ä–≥—ñ—é —Å–ø–µ–∫—Ç—Ä–∞**.

#### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏
- `input` ‚Äî `array('h')` –¥–æ–≤–∂–∏–Ω–æ—é **512**
  - –∑–Ω–∞—á–µ–Ω–Ω—è `int16`
  - —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: `¬±10000`

#### –ü–æ–≤–µ—Ä—Ç–∞—î
- `memoryview('i')` –¥–æ–≤–∂–∏–Ω–æ—é **256**
  - `int32`
  - –µ–Ω–µ—Ä–≥—ñ—è —Å–ø–µ–∫—Ç—Ä–∞ (`|FFT|¬≤`, –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–∞)

#### –ó–∞—É–≤–∞–∂–µ–Ω–Ω—è
- DC-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (`bin 0`) –ø—Ä–∏–º—É—Å–æ–≤–æ –¥–æ—Ä—ñ–≤–Ω—é—î `0`
- Nyquist-–±—ñ–Ω (`256`) –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è

---

## üß™ –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –æ–¥–Ω—ñ—î—ó –≥–∞—Ä–º–æ–Ω—ñ–∫–∏ —Ç–∞ FFT

```python
from array import array
import math
import fastfft

FFT_SIZE = 512
fs = 8000          # —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü—ñ—ó
k = 32             # –Ω–æ–º–µ—Ä FFT-–±—ñ–Ω–∞
f = fs * k / FFT_SIZE
amp = 10_000

buf = array('h', [0]*FFT_SIZE)

for n in range(FFT_SIZE):
    buf[n] = int(amp * math.sin(2*math.pi*f*n/fs))

spec = fastfft.rfft(buf)

peak_bin = max(range(len(spec)), key=lambda i: spec[i])
print("Peak bin:", peak_bin)
print("Peak energy:", spec[peak_bin])
```

–û—á—ñ–∫—É–≤–∞–Ω–æ:  
```python
Peak bin: 32
Peak energy ‚âà 25_000_000
```
## üìä –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
#### –¢–∏–ø –≤—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö  
```python
array('h')  # int16
```
#### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω  
```python
¬±10000  (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
¬±15000  (–≤–µ—Ä—Ö–Ω—è –±–µ–∑–ø–µ—á–Ω–∞ –º–µ–∂–∞)
```
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É int16 (¬±32767) –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è  
—á–µ—Ä–µ–∑:
- –º–æ–∂–ª–∏–≤–∏–π –∫–ª—ñ–ø—ñ–Ω–≥ –¥–∂–µ—Ä–µ–ª–∞ —Å–∏–≥–Ω–∞–ª—É,
- –≤—Ç—Ä–∞—Ç—É —Ç–æ—á–Ω–æ—Å—Ç—ñ float-–æ–±—á–∏—Å–ª–µ–Ω—å.

---  

## ‚è± –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (RP2040 @133 –ú–ì—Ü)

–ü–æ–≤–Ω–∏–π –≤–∏–∫–ª–∏–∫ rfft() ~12 ms  
–Ø–∫ –≤–∏–º—ñ—Ä—é–≤–∞–ª–æ—Å—å: 
```python
from array import array
import fastfft
import time

buf = array('h', [0] * 512)

# –ø—Ä–æ–≥—Ä—ñ–≤ (–≤–∞–∂–ª–∏–≤–æ!)
for _ in range(5):
    fastfft.rfft(buf)

t0 = time.ticks_us()
s = fastfft.rfft(buf)
t1 = time.ticks_us()

dt = time.ticks_diff(t1, t0)
print("FFT time:", dt, "us")
```
---  

## ‚öóÔ∏è –î–µ—è–∫—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∞ –ø—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
#### ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –µ–Ω–µ—Ä–≥—ñ—ó —Å–∏–≥–Ω–∞–ª—É –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è (—Ç–µ–æ—Ä–µ–º–∞ –õ—è–ø—É–Ω–æ–≤–∞-–ü–∞—Ä—Å–µ–≤–∞–ª—è)
```python
from array import array
import fastfft
import random


FFT_SIZE = 512
amp = 10_000        # –ø—ñ–∫ —Å–∏–≥–Ω–∞–ª—É (–±–µ–∑ clipping)

buf = array('h', [0]*FFT_SIZE)

# —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –±—ñ–ª–∏–π —à—É–º
for i in range(FFT_SIZE):
    buf[i] = random.randint(-amp, amp)

# –µ–Ω–µ—Ä–≥—ñ—è —É —á–∞—Å—ñ
Et = sum(x*x for x in buf)

spec = fastfft.rfft(buf)

# –µ–Ω–µ—Ä–≥—ñ—è —É —á–∞—Å—Ç–æ—Ç—ñ
Ef = 2 * sum(spec[1:]) * FFT_SIZE

print(f'–ü–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ ~–æ–¥–Ω–∞–∫–æ–≤—ñ: {Et} ~= {Ef}') # –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ ~–æ–¥–Ω–∞–∫–æ–≤—ñ
```
#### :seedling: –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è —Å–∏–≥–Ω–∞–ª—É –≤ dBFS (–¥–ë –ø–æ–≤–Ω–æ—ó —à–∫–∞–ª–∏) –¥–ª—è —Å–º—É–≥–∏ —á–∞—Å—Ç–æ—Ç  
```python
from array import array
import math
import fastfft
import random


FFT_SIZE = 512
amp = 10_000        # –ø—ñ–∫ —Å–∏–≥–Ω–∞–ª—É (–±–µ–∑ clipping)

buf = array('h', [0]*FFT_SIZE)

# —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∏–≥–Ω–∞–ª –±—ñ–ª–∏–π —à—É–º
for i in range(FFT_SIZE):
    buf[i] = random.randint(-amp, amp)

spec = fastfft.rfft(buf)

# –û–ø–æ—Ä–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –ø–æ–≤–Ω–æ–º–∞—Å—à—Ç–∞–±–Ω–æ–≥–æ —Å–∏–Ω—É—Å–∞ (Standard AES17 Reference)
FS_RMS2 = (32767 / math.sqrt(2))**2

# –∑–Ω–∞—á–µ–Ω–Ω—è dBFS –¥–ª—è —Å–º—É–≥–∏ —á–∞—Å—Ç–æ—Ç
def band_dbfs(spec, i, j):
    
    e = 0
    for k in range(i, j):
        e += spec[k]
    
    if e <= 0:
        return -120
    
    return 10 * math.log10((2 * e) / FS_RMS2)

pin_1, pin_2 = 4, 50 # –∑–Ω–∞—á–µ–Ω–Ω—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É –ø—ñ–Ω—ñ–≤ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É
dbfs_for_band = band_dbfs(spec, pin_1, pin_2)
print(dbfs_for_band)
```

---  

## üîí –ì–∞—Ä–∞–Ω—Ç—ñ—ó –±–µ–∑–ø–µ–∫–∏
- –í—Å—ñ –±—É—Ñ–µ—Ä–∏ ‚Äî —Å—Ç–∞—Ç–∏—á–Ω—ñ
- –í—ñ–¥—Å—É—Ç–Ω—ñ malloc/free –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è int32
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—ñ–≤ —ñ —Ä–æ–∑–º—ñ—Ä—É –≤—Ö—ñ–¥–Ω–æ–≥–æ –º–∞—Å–∏–≤—É

---  
---

## üîß Building MicroPython with `fastfft` module

---

–¶–µ–π —Ä–æ–∑–¥—ñ–ª –æ–ø–∏—Å—É—î, —è–∫ **–≤–º–æ–Ω—Ç—É–≤–∞—Ç–∏ –º–æ–¥—É–ª—å `fastfft` —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø—Ä–æ—à–∏–≤–∫—É MicroPython**
—Ç–∞ –∑—ñ–±—Ä–∞—Ç–∏ –≥–æ—Ç–æ–≤–∏–π —Ñ–∞–π–ª –ø—Ä–æ—à–∏–≤–∫–∏ `.uf2` –¥–ª—è RP2040 (Raspberry Pi Pico).

–ú–æ–¥—É–ª—å –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è —è–∫ **C user module** —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω—ñ–∑–º `usermods`.

---

### üìã –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

–û—á—ñ–∫—É—î—Ç—å—Å—è, —â–æ —É –≤–∞—Å –≤–∂–µ —î:

- –∫–ª–æ–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é **MicroPython**
- –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π **Pico SDK**
- —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–±—ñ—Ä–∫–∏ (`cmake`, `make`)
- –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä `arm-none-eabi-gcc` –¥–æ—Å—Ç—É–ø–Ω–∏–π —É `PATH`

–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–∞:

```bash
arm-none-eabi-gcc --version
```
### üìÅ –†–æ–∑–º—ñ—â–µ–Ω–Ω—è –º–æ–¥—É–ª—è —Ç–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ–∞–π–ª–∏

–°–∫–æ–ø—ñ—é–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –º–æ–¥—É–ª—è fastfft —Ä–∞–∑–æ–º –∑ —É—Å—ñ–º–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏ —É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é usermods.  
–§–∞–π–ª–∏ kiss_fft_guts.h, kiss_fft.c, kiss_fft.h, kiss_fft_log.h, kiss_fftr.c, kiss_fftr.h –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∑—è—Ç–∏ —ñ–∑ —Ä–µ–ø–æ–∑–∏—Ç–∞—Ä—ñ—è [kissFFT](https://github.com/mborgerding/kissfft)  

–ö–æ—Ä–µ–∫—Ç–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: 
```bash
micropython/usermods
‚îú‚îÄ‚îÄ fastfft
‚îÇ   ‚îú‚îÄ‚îÄ mod_fastfft.c
‚îÇ   ‚îú‚îÄ‚îÄ _kiss_fft_guts.h
‚îÇ   ‚îú‚îÄ‚îÄ kiss_fft.c
‚îÇ   ‚îú‚îÄ‚îÄ kiss_fft.h
‚îÇ   ‚îú‚îÄ‚îÄ kiss_fft_log.h
‚îÇ   ‚îú‚îÄ‚îÄ kiss_fftr.c
‚îÇ   ‚îú‚îÄ‚îÄ kiss_fftr.h
‚îÇ   ‚îî‚îÄ‚îÄ micropython.cmake
‚îî‚îÄ‚îÄ micropython.cmake
```
### üß© –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –º–æ–¥—É–ª—è

–§–∞–π–ª:  
```bash
micropython/usermods/micropython.cmake
```
–ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏:  
```bash
include(${CMAKE_CURRENT_LIST_DIR}/fastfft/micropython.cmake) 
```
–¶–µ –ø—ñ–¥–∫–ª—é—á–∞—î –º–æ–¥—É–ª—å fastfft –¥–æ —Å–∏—Å—Ç–µ–º–∏ –∑–±—ñ—Ä–∫–∏ MicroPython.  
### üß± –û–ø–∏—Å –º–æ–¥—É–ª—è  
–§–∞–π–ª:  
```cmake
micropython/usermods/fastfft/micropython.cmake
```
–ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏:
```cmake
set(FASTFFT_MOD_DIR ${CMAKE_CURRENT_LIST_DIR})

list(APPEND MICROPY_SOURCE_EXTMOD
    ${FASTFFT_MOD_DIR}/mod_fastfft.c
    ${FASTFFT_MOD_DIR}/kiss_fft.c
    ${FASTFFT_MOD_DIR}/kiss_fftr.c
)

list(APPEND MICROPY_INC_EXTMOD
    ${FASTFFT_MOD_DIR}
) 
```
### üèóÔ∏è –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏  
```bash
cd ~/micropython/ports/rp2
rm -rf build
mkdir build
cd build

cmake .. \
  -DPICO_BOARD=pico \
  -DUSER_C_MODULES=/home/alex/micropython/usermods

make -j4 | tee build.log
```
–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∑–±—ñ—Ä–∫–∏ –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª:  
```bash
firmware.uf2
```
### ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ—Å–ª—è –ø—Ä–æ—à–∏–≤–∫–∏  
```python
import fastfft
dir(fastfft)
```
---

## üìÑ Credits and License
- **fastfft module**: Licensed under MIT.
- **kissFFT**: This project uses the [kissFFT](https://github.com/mborgerding/kissfft) library by Mark Borgerding, licensed under the **BSD 3-Clause License**.
---  


